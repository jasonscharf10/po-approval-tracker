<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Approval Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Backend URL - your deployed Apps Script
        const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbz2dlQNwe56QsRgTUEQcqaCelX1DvfOucaTeVbGSwIK0YCC9Gor55q41a2gAGq5aBUwRQ/exec';

        function App() {
            const [pos, setPOs] = useState([]);
            const [selectedPO, setSelectedPO] = useState(null);
            const [approvalHistory, setApprovalHistory] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [departmentFilter, setDepartmentFilter] = useState('all');
            const [approverFilter, setApproverFilter] = useState('all');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [historyLoading, setHistoryLoading] = useState(false);

            const loadPOs = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    const response = await fetch(`${BACKEND_URL}?action=getPOs`);
                    const data = await response.json();
                    
                    if (data.error) {
                        setError(data.error);
                        setPOs([]);
                    } else {
                        setPOs(data.pos || []);
                    }
                } catch (err) {
                    setError(`Failed to load POs: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadPOs();
            }, []);

            const loadApprovalHistory = async (internalId) => {
                setHistoryLoading(true);
                
                try {
                    const response = await fetch(`${BACKEND_URL}?action=getApprovalHistory&internalId=${encodeURIComponent(internalId)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        setError(data.error);
                        setApprovalHistory([]);
                    } else {
                        setApprovalHistory(data.history || []);
                    }
                } catch (err) {
                    setError(`Failed to load approval history: ${err.message}`);
                    setApprovalHistory([]);
                } finally {
                    setHistoryLoading(false);
                }
            };

            const handlePOClick = async (po) => {
                setSelectedPO(po);
                const internalId = po.internal_id;
                await loadApprovalHistory(internalId);
            };

            const getPOId = (po) => {
                return po.po_number || po.document_number || po.id || po.number || 'N/A';
            };

            const getPOStatus = (po) => {
                return po.status || po.approval_status || po.state || 'Unknown';
            };

            const getVendorName = (po) => {
                return po.name || po.vendor || po.vendor_name || 'N/A';
            };

            const getDepartment = (po) => {
                return po['department_(no_hierarchy)'] || po.department || po.dept || 'N/A';
            };

            const getNextApprover = (po) => {
                return po.next_approver || po.current_approver || po.approver || null;
            };

            const getNetSuiteLink = (po) => {
                if (po.internal_id) {
                    return `https://4454619.app.netsuite.com/app/accounting/transactions/purchord.nl?id=${po.internal_id}`;
                }
                return null;
            };

            const filteredPOs = pos.filter(po => {
                const poId = getPOId(po).toString().toLowerCase();
                const vendor = getVendorName(po).toString().toLowerCase();
                const dept = getDepartment(po).toString().toLowerCase();
                const approver = (getNextApprover(po) || '').toString().toLowerCase();
                
                const matchesSearch = 
                    poId.includes(searchTerm.toLowerCase()) ||
                    vendor.includes(searchTerm.toLowerCase()) ||
                    dept.includes(searchTerm.toLowerCase()) ||
                    approver.includes(searchTerm.toLowerCase());
                
                const status = getPOStatus(po);
                const matchesStatus = statusFilter === 'all' || status === statusFilter;
                
                const department = getDepartment(po);
                const matchesDepartment = departmentFilter === 'all' || department === departmentFilter;
                
                const nextApprover = getNextApprover(po);
                const matchesApprover = approverFilter === 'all' || nextApprover === approverFilter;
                
                return matchesSearch && matchesStatus && matchesDepartment && matchesApprover;
            });

            const getStatusColor = (status) => {
                const statusLower = (status || '').toLowerCase();
                
                if (statusLower.includes('approved') && !statusLower.includes('pending')) {
                    return 'bg-green-100 text-green-800';
                }
                if (statusLower.includes('pending') || statusLower.includes('awaiting')) {
                    return 'bg-yellow-100 text-yellow-800';
                }
                if (statusLower.includes('reject')) {
                    return 'bg-red-100 text-red-800';
                }
                return 'bg-gray-100 text-gray-800';
            };

            const getActionIcon = (action) => {
                const actionLower = (action || '').toLowerCase();
                
                if (actionLower.includes('approve')) {
                    return <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
                }
                if (actionLower.includes('reject')) {
                    return <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
                }
                if (actionLower.includes('pending') || actionLower.includes('waiting')) {
                    return <svg className="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
                }
                return <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
            };

            const uniqueStatuses = [...new Set(pos.map(po => getPOStatus(po)))].filter(s => s);
            const uniqueDepartments = [...new Set(pos.map(po => getDepartment(po)))].filter(d => d && d !== 'N/A').sort();
            const uniqueApprovers = [...new Set(pos.map(po => getNextApprover(po)))].filter(a => a).sort();

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <svg className="w-12 h-12 text-blue-600 animate-spin mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            <p className="text-gray-600">Loading purchase orders...</p>
                        </div>
                    </div>
                );
            }

            if (error && pos.length === 0) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="bg-white rounded-lg shadow-md p-8 max-w-md">
                            <div className="text-red-600 mb-4">
                                <svg className="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <h2 className="text-xl font-bold text-gray-900 mb-2">Error Loading Data</h2>
                            <p className="text-gray-600 mb-4">{error}</p>
                            <button
                                onClick={loadPOs}
                                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                            >
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            if (selectedPO) {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div className="max-w-6xl mx-auto p-6">
                            <div className="mb-6">
                                <button
                                    onClick={() => {
                                        setSelectedPO(null);
                                        setApprovalHistory([]);
                                    }}
                                    className="flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-4"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                                    Back to PO List
                                </button>
                                <h1 className="text-3xl font-bold text-gray-900">Purchase Order Details</h1>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <div className="grid grid-cols-2 gap-6">
                                    <div className="col-span-2 flex justify-between items-start">
                                        <div>
                                            <p className="text-sm text-gray-500">PO Number</p>
                                            <p className="text-lg font-semibold text-gray-900">{getPOId(selectedPO)}</p>
                                        </div>
                                        {getNetSuiteLink(selectedPO) && (
                                            <a
                                                href={getNetSuiteLink(selectedPO)}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                                            >
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                                View in NetSuite
                                            </a>
                                        )}
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Status</p>
                                        <span className={`inline-block px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(getPOStatus(selectedPO))}`}>
                                            {getPOStatus(selectedPO)}
                                        </span>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Vendor</p>
                                        <p className="text-lg font-semibold text-gray-900">{getVendorName(selectedPO)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Department</p>
                                        <p className="text-lg font-semibold text-gray-900">{getDepartment(selectedPO)}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm text-gray-500">Date</p>
                                        <p className="text-lg font-semibold text-gray-900">{selectedPO.date || selectedPO.transaction_date || 'N/A'}</p>
                                    </div>
                                    {getNextApprover(selectedPO) && (
                                        <div>
                                            <p className="text-sm text-gray-500">Next Approver</p>
                                            <p className="text-lg font-semibold text-gray-900">{getNextApprover(selectedPO)}</p>
                                        </div>
                                    )}
                                    {selectedPO.memo && (
                                        <div className="col-span-2">
                                            <p className="text-sm text-gray-500">Memo</p>
                                            <p className="text-lg font-semibold text-gray-900">{selectedPO.memo}</p>
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-md p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold text-gray-900">Approval History</h2>
                                    {historyLoading && <svg className="w-5 h-5 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>}
                                </div>
                                
                                {approvalHistory.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">No approval history found</p>
                                ) : (
                                    <div className="space-y-4">
                                        {approvalHistory.map((entry, index) => (
                                            <div key={index} className="flex gap-4 pb-4 border-b last:border-b-0">
                                                <div className="flex-shrink-0 mt-1">
                                                    {getActionIcon(entry.action || entry.status)}
                                                </div>
                                                <div className="flex-grow">
                                                    <div className="flex justify-between items-start mb-1">
                                                        <div>
                                                            <p className="font-semibold text-gray-900">
                                                                {entry.action_owner || entry.approver || entry.user || entry.employee || 'System'}
                                                            </p>
                                                            <p className="text-sm text-gray-500">
                                                                {entry.date || entry.action_date || entry.timestamp || entry.created_date || 'N/A'}
                                                            </p>
                                                        </div>
                                                        <span className={`px-2 py-1 rounded text-xs font-medium ${getStatusColor(entry.status || entry.action)}`}>
                                                            {entry.status || entry.action || 'N/A'}
                                                        </span>
                                                    </div>
                                                    {entry.comments && (
                                                        <p className="text-sm text-gray-700 mt-2">{entry.comments}</p>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="max-w-7xl mx-auto p-6">
                        <div className="mb-6 flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-900">Purchase Orders</h1>
                                <p className="text-gray-600 mt-1">Track and manage purchase order approvals</p>
                            </div>
                            <button
                                onClick={loadPOs}
                                className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Refresh
                            </button>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-4 mb-6">
                            <div className="flex gap-4 flex-wrap">
                                <div className="flex-grow">
                                    <div className="relative">
                                        <svg className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                        <input
                                            type="text"
                                            placeholder="Search by PO number, vendor, department, or approver..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <svg className="text-gray-400 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                                    <select
                                        value={statusFilter}
                                        onChange={(e) => setStatusFilter(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">All Status</option>
                                        {uniqueStatuses.map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <select
                                        value={departmentFilter}
                                        onChange={(e) => setDepartmentFilter(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">All Departments</option>
                                        {uniqueDepartments.map(dept => (
                                            <option key={dept} value={dept}>{dept}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex items-center gap-2">
                                    <select
                                        value={approverFilter}
                                        onChange={(e) => setApproverFilter(e.target.value)}
                                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="all">All Approvers</option>
                                        {uniqueApprovers.map(approver => (
                                            <option key={approver} value={approver}>{approver}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            {filteredPOs.length === 0 ? (
                                <div className="bg-white rounded-lg shadow-md p-8 text-center">
                                    <p className="text-gray-500">No purchase orders found</p>
                                </div>
                            ) : (
                                filteredPOs.map((po, index) => (
                                    <div
                                        key={index}
                                        onClick={() => handlePOClick(po)}
                                        className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer"
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center gap-3">
                                                <div>
                                                    <h3 className="text-xl font-semibold text-gray-900">{getPOId(po)}</h3>
                                                    <p className="text-gray-600">{getVendorName(po)}</p>
                                                </div>
                                                {getNetSuiteLink(po) && (
                                                    <a
                                                        href={getNetSuiteLink(po)}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        onClick={(e) => e.stopPropagation()}
                                                        className="text-blue-600 hover:text-blue-700"
                                                        title="View in NetSuite"
                                                    >
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                                    </a>
                                                )}
                                            </div>
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(getPOStatus(po))}`}>
                                                {getPOStatus(po)}
                                            </span>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                                            <div className="flex items-center gap-2">
                                                <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                                <div>
                                                    <p className="text-gray-500">Date</p>
                                                    <p className="font-semibold text-gray-900">{po.date || po.transaction_date || 'N/A'}</p>
                                                </div>
                                            </div>
                                            
                                            <div className="flex items-center gap-2">
                                                <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                                <div>
                                                    <p className="text-gray-500">Department</p>
                                                    <p className="font-semibold text-gray-900">{getDepartment(po)}</p>
                                                </div>
                                            </div>
                                            
                                            {getNextApprover(po) && (
                                                <div className="flex items-center gap-2">
                                                    <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                                    <div>
                                                        <p className="text-gray-500">Next Approver</p>
                                                        <p className="font-semibold text-gray-900">{getNextApprover(po)}</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        
                                        {po.memo && (
                                            <div className="mt-4 pt-4 border-t border-gray-200">
                                                <p className="text-sm text-gray-700">{po.memo}</p>
                                            </div>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>